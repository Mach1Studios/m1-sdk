language: cpp
env:
  global:
    - secure: xq88wTHbDzhUaA8KEVVLtiETOccPOShPlWdcuJIvsGRKSSLI8hSDhGR0ZFWrvpx56t6lgrqVrEOUqIoLLDM06mltNBpe+218lKs3wKnNuxET8MrZ6m05oC6n0uavXIgnxbC8mChYqeZHd2mQ0riGfPsxue9GIKsiq27WZvuB+AdoYE4HvuOrRPYN63EeiAhx4BnY31GlEGbiEd0zFsDmTI8lL3boCZ/P4aK/SYdCV3BfJ0VkqT+UNo2HWnOBJAR1A63cu0gznmLNG2gv1Wd9gxntbPKXaa2Qc/HtIqOab4Jyl+TIzh5582s+oPgIgX8349/0n1o5dNmjWu64j02LwynV87+aflyK8P9kYCdnJosPjjktEM4L8kWOpVrH+0Go8VDdLf3Ar9C0f1urQ27g+fCIMRO7xPN7sceLP1c2L7LNUp2wx2ItTovJhcZa1cb6OmXbVURsjRCum8WYXpkJ08Tu34roPX45avLMh2JCf7dzJ3EoUhnd43/o+E+Eme4Nes0fYMAQEKK881C9uQljcuYmKuJ/uOTvStP68fOYvc1xnb3RT/OpHvaX6dX5QKrBZnk0fVWMcLtxfT3lvdtt5u73gWcdu+kzBXdEtwpGajeSXlPdhUOzDukccatQrQt97eybFdUC/9C04FLQ4OlBNpS+VFELaBkfJsNq0ThPQFo=

branches:
  only:
    - travis-test
    - develop
    - deploy
    - master

git:
  lfs_skip_smudge: true
  depth: 2

before_script:
  - echo -e "Host github.com\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
  - eval "${MATRIX_EVAL}"

after_script:
  - if [ "$TRAVIS_OS_NAME" == "osx" ]; then cd ${TRAVIS_BUILD_DIR}/source && ./scripts/remove_signing_key.sh; fi

stages:
  - name: test
  - name: compile
    if: branch = deploy OR branch = travis-test
  - name: deploy
    if: branch = deploy
  - name: release
    if: branch = master

# ---------------------------------
#
# Test: libs 
#
# ---------------------------------

jobs:
  include:
    - stage: test
      name: Test Compile Libs
      os: linux
      sudo: required
      dist: bionic
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - build-essential
            - g++-7
            - cmake
      env:
        - MATRIX_EVAL="CC=gcc-7 CXX=g++-7"
      git:
        submodules: false
      before_install:
        - cd ${TRAVIS_BUILD_DIR}
        - ./source/scripts/check-changes.sh ./source ; RETURN_CODE=$? ; if [ $RETURN_CODE -eq 137 ]; then travis_terminate 0; elif [ $RETURN_CODE -ne 0 ]; then travis_terminate $RETURN_CODE; fi
      script:
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/linux_simpletest.sh

# ---------------------------------
#
# Compile: libs 
#
# ---------------------------------

    - stage: compile
      branches:
        only:
          - deploy
          - travis-test
      name: Linux x86_64
      os: linux
      sudo: required
      dist: bionic
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - build-essential
            - g++-7
            - libpthread-stubs0-dev
            - rsync
            - awscli
            - cmake
      env:
        - MATRIX_EVAL="CC=gcc-7 CXX=g++-7"
      script:
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/linux_build.sh
      after_success:
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/examples_linking_test.sh

    - stage: compile
      branches:
        only:
          - deploy
          - travis-test
      name: Linux ARM64
      os: linux
      sudo: required
      arch: arm64
      dist: bionic
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - build-essential
            - libpthread-stubs0-dev
            - rsync
            - awscli
            - gcc-arm-linux-gnueabi
            - gcc-arm-linux-gnueabihf
            - lib32z1
            - lib32ncurses5
            - binutils
            - binutils-source
            - patch
            - libssl-dev
            - bc
            - flex
            - bison
            - gawk
            - libncurses5-dev
            - gettext
            - autoconf
            - texinfo
            - cmake
          update: true
      env:
        - CROSS_COMPILE=arm-none-eabi-
        - CC=$(CROSS_COMPILE)gcc 
        - CXX=$(CROSS_COMPILE)g++
      install:
        - export PATH=/usr/local/bin:$PATH
        - sudo apt remove binutils-arm-none-eabi gcc-arm-none-eabi libnewlib-arm-none-eabi
        - cd ${TRAVIS_BUILD_DIR}
        - wget --quiet https://developer.arm.com/-/media/Files/downloads/gnu-rm/7-2018q2/gcc-arm-none-eabi-7-2018-q2-update-linux.tar.bz2
        - tar -xf gcc-arm-none-eabi-7-2018-q2-update-linux.tar.bz2
        - cd gcc-arm-none-eabi-7-2018-q2-update
        - export PATH=${TRAVIS_BUILD_DIR}/gcc-arm-none-eabi-7-2018-q2-update/bin/:$PATH
      script:
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/linux-arm_build.sh
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/arm-cortexm0_build.sh
        # - export CROSS_COMPILE=/usr/bin/arm-linux-gnueabihf-
        # - cd ${TRAVIS_BUILD_DIR}/source
        # - ./scripts/arm-hf_build.sh
        # - cd ${TRAVIS_BUILD_DIR}/source
        # - ./scripts/arm-hf-neon-vfpv4_build.sh

    - stage: compile
      branches:
        only:
          - deploy
          - travis-test
      name: macOS 9.3 (macOS 10.13)
      os: osx
      sudo: required
      osx_image: xcode9.3
      env:
        - HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK=1
        - HOMEBREW_NO_AUTO_UPDATE=1
        - MACOSX_DEPLOYMENT_TARGET=10.9
      cache:
        directories:
          - $HOME/Library/Caches/Homebrew
      before_cache:
        - brew cleanup
      install: 
        - cd ${TRAVIS_BUILD_DIR}/source
        - sudo pip install --upgrade pip
        - sudo python -m pip install awscli --ignore-installed six
      script:
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/macos-10-13_build.sh
      after_success:
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/examples_linking_test.sh

    - stage: compile
      branches:
        only:
          - deploy
          - travis-test
      name: macOS 9.3 (iOS)
      os: osx
      sudo: required
      osx_image: xcode9.3
      env:
        - HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK=1
        - HOMEBREW_NO_AUTO_UPDATE=1
        - MACOSX_DEPLOYMENT_TARGET=10.9
        - IOS_DEVELOPMENT_TEAM="6ZETDT84RB"
        - IOS_BUNDLE_IDENTIFIER="com.mach1.lib"
      cache:
        directories:
          - $HOME/Library/Caches/Homebrew
          - ${TRAVIS_BUILD_DIR}/cmake-3.19.3
          - ${TRAVIS_BUILD_DIR}/cmake-3.19.3.zip
      before_cache:
        - brew cleanup
      before_install:
          - if [ "$TRAVIS_OS_NAME" == "osx" ]; then cd ${TRAVIS_BUILD_DIR}/source/scripts && openssl aes-256-cbc -K $encrypted_b7b9d4064d90_key -iv $encrypted_b7b9d4064d90_iv -in certs/secrets.tar.enc -out certs/secrets.tar -d; fi
          - if [ "$TRAVIS_OS_NAME" == "osx" ]; then cd ${TRAVIS_BUILD_DIR}/source && ./scripts/add_signing_key.sh; fi
      install:
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/ios_setup.sh
        - sudo pip install --upgrade pip
        - sudo python -m pip install awscli --ignore-installed six
      script:
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/ios_build.sh
      after_success:
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/examples_linking_test.sh

    - stage: compile
      branches:
        only:
          - deploy
          - travis-test
      name: macOS 13.2 (macOS)
      os: osx
      addons:
        homebrew:
          packages:
            - libpthread-stubs
            - rsync
            - awscli
      osx_image: xcode13.2
      env:
        - MATRIX_EVAL="CC=gcc CXX=g++"
        - HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK=1
        - HOMEBREW_NO_AUTO_UPDATE=1
      cache:
        directories:
          - $HOME/Library/Caches/Homebrew
      before_cache:
        - brew cleanup
      script:
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/macos_build.sh
      after_success:
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/examples_linking_test.sh

    - stage: compile
      branches:
        only:
          - deploy
          - travis-test
      name: Linux x86_64 (RPI)
      os: linux
      sudo: required
      dist: bionic
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - build-essential
            - g++-7
            - libpthread-stubs0-dev
            - rsync
            - awscli
            - cmake
            - qemu-user-static
      env:
        - RPI_TOOLS=${HOME}/rpi/tools
      install:
        - mkdir -p ~/rpi/
        - cd ~/rpi
        - git clone https://github.com/raspberrypi/tools.git
      script:
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/rpi_build.sh
      after_success:
        # TODO: Setup RPI testing

    - stage: compile
      branches:
        only:
          - deploy
          - travis-test
      name: Linux x86_64 (WASM/JS)
      os: linux
      sudo: required
      dist: bionic
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - build-essential
            - g++-7
            - libpthread-stubs0-dev
            - rsync
            - awscli
            - cmake
      env:
        - MATRIX_EVAL="CC=gcc-7 CXX=g++-7"
      install:
        - cd ${TRAVIS_BUILD_DIR}
        - git clone https://github.com/emscripten-core/emsdk.git
        - cd emsdk && git pull
        - ./emsdk install latest
        - ./emsdk activate latest
        - source ./emsdk_env.sh
      script:
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/web_build.sh

    - stage: compile
      branches:
        only:
          - deploy
          - travis-test
      name: Android
      os: linux
      language: android
      dist: trusty
      sudo: true
      android:
        components:
          - tools
          - platform-tools
          - build-tools-21.1.2
          - android-21
          - add-on
          - extra
      licenses:
        - 'android-sdk-preview-license-.+'
        - 'android-sdk-license-.+'
      addons:
        apt:
          - build-essential
          - rsync
          - cmake
          - awscli
        update: true
      env: 
        - MATRIX_EVAL="CC=gcc-7 CXX=g++-7 ANDROID_NDK_r16b=${TRAVIS_BUILD_DIR}/android-ndk-r16b"
      install: 
        - cd ${TRAVIS_BUILD_DIR}
        - echo y | sdkmanager 'ndk;21.1.6352462'
        - echo y | sdkmanager "cmake;3.10.2.4988404"
        - wget --quiet https://dl.google.com/android/repository/android-ndk-r16b-linux-x86_64.zip
        - unzip -qq android-ndk-r16b-linux-x86_64.zip
        - export ANDROID_NDK_HOME=`pwd`/android-ndk-r16b
        - export ANDROID_NDK_r16b=`pwd`/android-ndk-r16b
        - export LOCAL_ANDROID_NDK_HOME="$ANDROID_NDK_HOME"
        - export LOCAL_ANDROID_NDK_HOST_PLATFORM="linux-x86_64"
        - export PATH=$PATH:${ANDROID_NDK_HOME}
      script:
        # Android Build on linux
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/android_build.sh

    - stage: compile
      branches:
        only:
          - deploy
          - travis-test
      name: Windows
      os: windows
      language: sh
      env:
        - VS15=true
      before_install:
        - git clone https://github.com/pyenv-win/pyenv-win.git $HOME/.pyenv
        - export PATH="$HOME/.pyenv/pyenv-win/bin:$HOME/.pyenv/pyenv-win/shims:$PATH"
        - pyenv install -q 3.7.1
        - pyenv rehash
        - pyenv local 3.7.1
        - python --version
        - pip install requests
        - git lfs pull --include "m1-debug-shortpt-fiveone.wav"
      install:
        - cd ${TRAVIS_BUILD_DIR}/source
        - choco install -y cmake
        - choco install -y make
        - choco install -y rsync
        - choco install -y awscli
        - export PATH="$(powershell -Command '("Process", "Machine" | % {[Environment]::GetEnvironmentVariable("PATH", $_) -Split ";" -Replace "\\$", ""} | Select -Unique | % { cygpath $_ }) -Join ":"')"
      script:
        # WINDOWS BUILDS
        - cd ${TRAVIS_BUILD_DIR}/source
        - ./scripts/win_build.sh

# ---------------------------------
#
# Compile: m1-transcode 
#
# ---------------------------------

    - stage: compile
      branches:
        only:
          - deploy
          - travis-test
      name: m1-transcode Linux-x86_64
      os: linux
      sudo: required
      dist: focal
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - build-essential
            - g++-7
            - libasound2-dev
            - libvorbis-dev
            - libflac-dev
            - libopus-dev
            - libogg-dev
            - libmpg123-dev
            - libmp3lame-dev
            - libtool
            - libpthread-stubs0-dev
            - rsync
            - awscli
            - libboost-all-dev
            - cmake
          update: true
      git:
        submodules: false
      install:
        - cd ${TRAVIS_BUILD_DIR}/../
        - git clone git@github.com:Mach1Studios/m1-transcode.git
        - cd ${TRAVIS_BUILD_DIR}/../m1-transcode
        - mkdir libs && cd libs
        - git clone --depth 1 git@github.com:libsndfile/libsndfile.git
        - git clone --depth 1 git@github.com:ebu/libadm.git
        - git clone --depth 1 git@github.com:irt-open-source/libbw64.git
      script:
        - cd ${TRAVIS_BUILD_DIR}/../m1-transcode
        - cmake . -DENABLE_SHARED=OFF -DBUILD_SHARED_LIBS=OFF -DBUILD_PROGRAMS=OFF -DBUILD_EXAMPLES=OFF -DBUILD_TESTING=OFF -DADM_EXAMPLES=OFF -DADM_UNIT_TESTS=OFF-DADM_PACKAGE_AND_INSTALL=OFF -DBW64_EXAMPLES=OFF -DBW64_UNIT_TESTS=OFF -DBW64_PACKAGE_AND_INSTALL=OFF
        - cmake --build . --config Release
      after_success:
        - cd ${TRAVIS_BUILD_DIR}/../m1-transcode
        - cp -f ./m1-transcode ${TRAVIS_BUILD_DIR}/executables/unix/m1-transcode
        - aws s3 cp m1-transcode s3://${AWS_DEPLOY_BUCKET}/executables/linux/m1-transcode --cache-control no-cache --metadata-directive REPLACE

    - stage: compile
      branches:
        only:
          - deploy
          - travis-test
      name: m1-transcode Linux-ARM64
      os: linux
      sudo: required
      arch: arm64
      dist: focal
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - build-essential
            - libasound2-dev
            - libvorbis-dev
            - libflac-dev
            - libopus-dev
            - libogg-dev
            - libmpg123-dev
            - libmp3lame-dev
            - libtool
            - libpthread-stubs0-dev
            - rsync
            - awscli
            - gcc-arm-linux-gnueabi
            - binutils
            - patch
            - libssl-dev
            - bc
            - flex
            - bison
            - gawk
            - libncurses5-dev
            - gettext
            - autoconf
            - texinfo
            - libboost-all-dev
            - cmake
          update: true
      env:
        - CROSS_COMPILE=arm-none-eabi-
        - CC=$(CROSS_COMPILE)gcc 
        - CXX=$(CROSS_COMPILE)g++
      git:
        submodules: false
      install:
        - sudo apt remove binutils-arm-none-eabi gcc-arm-none-eabi libnewlib-arm-none-eabi
        - cd ${TRAVIS_BUILD_DIR}
        - wget --quiet https://developer.arm.com/-/media/Files/downloads/gnu-rm/7-2018q2/gcc-arm-none-eabi-7-2018-q2-update-linux.tar.bz2
        - tar -xf gcc-arm-none-eabi-7-2018-q2-update-linux.tar.bz2
        - cd gcc-arm-none-eabi-7-2018-q2-update
        - export PATH=${TRAVIS_BUILD_DIR}/gcc-arm-none-eabi-7-2018-q2-update/bin/:$PATH
        - cd ${TRAVIS_BUILD_DIR}/../
        - git clone git@github.com:Mach1Studios/m1-transcode.git
        - cd ${TRAVIS_BUILD_DIR}/../m1-transcode
        - mkdir libs && cd libs
        - git clone --depth 1 git@github.com:libsndfile/libsndfile.git
        - git clone --depth 1 git@github.com:ebu/libadm.git
        - git clone --depth 1 git@github.com:irt-open-source/libbw64.git
      script:
        - cd ${TRAVIS_BUILD_DIR}/../m1-transcode
        - cmake . -DENABLE_SHARED=OFF -DBUILD_SHARED_LIBS=OFF -DBUILD_PROGRAMS=OFF -DBUILD_EXAMPLES=OFF -DBUILD_TESTING=OFF -DADM_EXAMPLES=OFF -DADM_UNIT_TESTS=OFF-DADM_PACKAGE_AND_INSTALL=OFF -DBW64_EXAMPLES=OFF -DBW64_UNIT_TESTS=OFF -DBW64_PACKAGE_AND_INSTALL=OFF
        - cmake --build . --config Release
      after_success:
        - cd ${TRAVIS_BUILD_DIR}/../m1-transcode
        - cp -f ./m1-transcode ${TRAVIS_BUILD_DIR}/executables/linux-arm/m1-transcode
        - aws s3 cp m1-transcode s3://${AWS_DEPLOY_BUCKET}/executables/linux-arm/m1-transcode --cache-control no-cache --metadata-directive REPLACE

    - stage: compile
      branches:
        only:
          - deploy
          - travis-test
      name: m1-transcode Windows
      os: windows
      language: sh
      env:
        - VCPKG_ROOT=${TRAVIS_BUILD_DIR}/vcpkg
        - VCPKG_PATH=${VCPKG_ROOT}
        - VCPKG_DEFINES="-DCMAKE_TOOLCHAIN_FILE=${TRAVIS_BUILD_DIR}/vcpkg/scripts/buildsystems/vcpkg.cmake"
      cache:
        timeout: 1000
        directories:
          - ${TRAVIS_BUILD_DIR}/vcpkg
          - ${TRAVIS_BUILD_DIR}/.cache/vcpkg
      git:
        submodules: false
      before_cache:
        - git clone https://github.com/Microsoft/vcpkg.git ${TRAVIS_BUILD_DIR}/vcpkg
        - cd ${TRAVIS_BUILD_DIR}
        - ./vcpkg/bootstrap-vcpkg.bat
      before_install:
        - cd ${TRAVIS_BUILD_DIR}
        - git lfs pull --include "m1-debug-shortpt-fiveone.wav"
      install:
        - cd ${TRAVIS_BUILD_DIR}
        - if [ -d "${TRAVIS_BUILD_DIR}/vcpkg/.git" ] ; then echo vcpkg cached ; else rm -rf vcpkg ; git clone https://github.com/Microsoft/vcpkg ; fi
        - cd vcpkg
        - git checkout .
        - git pull
        - ./bootstrap-vcpkg.bat
        - cd ${TRAVIS_BUILD_DIR}/source
        - choco install -y cmake --installargs 'ADD_CMAKE_TO_PATH=System'
        - choco install -y make
        - choco install -y awscli
        - choco install -y boost-msvc-14.1
        - choco install -y pkgconfiglite
        - export PATH="$(powershell -Command '("Process", "Machine" | % {[Environment]::GetEnvironmentVariable("PATH", $_) -Split ";" -Replace "\\$", ""} | Select -Unique | % { cygpath $_ }) -Join ":"')"
        - ${TRAVIS_BUILD_DIR}/vcpkg/vcpkg.exe install libvorbis:x64-windows libvorbis:x64-windows-static libvorbis:x86-windows libflac:x64-windows libflac:x64-windows-static libflac:x86-windows opus:x64-windows opus:x64-windows-static opus:x86-windows mp3lame:x64-windows mp3lame:x64-windows-static mp3lame:x86-windows mpg123:x64-windows mpg123:x64-windows-static mpg123:x86-windows
        - cd ${TRAVIS_BUILD_DIR}/../
        - git clone git@github.com:Mach1Studios/m1-transcode.git
        - cd ${TRAVIS_BUILD_DIR}/../m1-transcode
        - mkdir libs && cd libs
        - git clone --depth 1 git@github.com:libsndfile/libsndfile.git
        - git clone --depth 1 git@github.com:ebu/libadm.git
        - git clone --depth 1 git@github.com:irt-open-source/libbw64.git
      script:
        - cd ${TRAVIS_BUILD_DIR}/../m1-transcode
        - cmake . -DENABLE_PACKAGE_CONFIG=ON -DENABLE_SHARED=OFF -DBUILD_SHARED_LIBS=OFF -DBUILD_PROGRAMS=OFF -DBUILD_EXAMPLES=OFF -DBUILD_TESTING=OFF -DADM_EXAMPLES=OFF -DADM_UNIT_TESTS=OFF-DADM_PACKAGE_AND_INSTALL=OFF -DBW64_EXAMPLES=OFF -DBW64_UNIT_TESTS=OFF -DBW64_PACKAGE_AND_INSTALL=OFF -DENABLE_STATIC_RUNTIME=ON -DCMAKE_EXE_LINKER_FLAGS="-static" -DCMAKE_TOOLCHAIN_FILE=${TRAVIS_BUILD_DIR}/vcpkg/scripts/buildsystems/vcpkg.cmake -B_builds/vs-15-2017 -G "Visual Studio 15 2017" -A Win32 -DCMAKE_INSTALL_PREFIX=_install/vs-15-2017
        - cmake --build _builds/vs-15-2017 --config Release --target install -- //nologo //verbosity:quiet //clp:ErrorsOnly
        - cmake . -DENABLE_PACKAGE_CONFIG=ON -DENABLE_SHARED=OFF -DBUILD_SHARED_LIBS=OFF -DBUILD_PROGRAMS=OFF -DBUILD_EXAMPLES=OFF -DBUILD_TESTING=OFF -DADM_EXAMPLES=OFF -DADM_UNIT_TESTS=OFF-DADM_PACKAGE_AND_INSTALL=OFF -DBW64_EXAMPLES=OFF -DBW64_UNIT_TESTS=OFF -DBW64_PACKAGE_AND_INSTALL=OFF -DENABLE_STATIC_RUNTIME=ON -DCMAKE_EXE_LINKER_FLAGS="-static" -DCMAKE_TOOLCHAIN_FILE=${TRAVIS_BUILD_DIR}/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows-static -B_builds/vs-15-2017-win64 -G "Visual Studio 15 2017" -A x64 -DCMAKE_INSTALL_PREFIX=_install/vs-15-2017-win64
        - cmake --build _builds/vs-15-2017-win64 --config Release --target install -- //nologo //verbosity:quiet //clp:ErrorsOnly
      after_success:
        - cd ${TRAVIS_BUILD_DIR}/../m1-transcode
        - cp -f _install/vs-15-2017/build/m1-transcode.exe ${TRAVIS_BUILD_DIR}/executables/windows-x86/m1-transcode.exe
        - cp -f _install/vs-15-2017-win64/build/m1-transcode.exe ${TRAVIS_BUILD_DIR}/executables/windows-x86_64/m1-transcode.exe
        - aws s3 cp _install/vs-15-2017/build/m1-transcode.exe s3://${AWS_DEPLOY_BUCKET}/executables/windows-x86/m1-transcode.exe --cache-control no-cache --metadata-directive REPLACE
        - aws s3 cp _install/vs-15-2017-win64/build/m1-transcode.exe s3://${AWS_DEPLOY_BUCKET}/executables/windows-x86_64/m1-transcode.exe --cache-control no-cache --metadata-directive REPLACE

    - stage: compile
      branches:
        only:
          - deploy
          - travis-test
      name: m1-transcode macOS
      os: osx
      addons:
        homebrew:
          packages:
            - libvorbis
            - libogg
            - flac
            - opus-tools
            - mpg123
            - lame
            - libtool
            - libpthread-stubs
            - git-lfs
            - rsync
            - awscli
      env:
        - HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK=1
        - HOMEBREW_NO_AUTO_UPDATE=1
      osx_image: xcode13.2
      cache:
        directories:
          - $HOME/Library/Caches/Homebrew
      before_cache:
        - brew cleanup
      git:
        submodules: false
      install:
        - brew tap irt-open-source/homebrew-nga
        - brew install libadm libbw64
      script:
        - cd ${TRAVIS_BUILD_DIR}/../
        - git clone git@github.com:Mach1Studios/m1-transcode.git
        - cd ${TRAVIS_BUILD_DIR}/../m1-transcode
        - mkdir libs && cd libs
        - git clone --depth 1 git@github.com:libsndfile/libsndfile.git
        - git clone --depth 1 git@github.com:ebu/libadm.git
        - git clone --depth 1 git@github.com:irt-open-source/libbw64.git
        - cd ${TRAVIS_BUILD_DIR}/../m1-transcode
        - cmake . -DENABLE_SHARED=OFF -DBUILD_SHARED_LIBS=OFF -DBUILD_PROGRAMS=OFF -DBUILD_EXAMPLES=OFF -DBUILD_TESTING=OFF -DADM_EXAMPLES=OFF -DADM_UNIT_TESTS=OFF-DADM_PACKAGE_AND_INSTALL=OFF -DBW64_EXAMPLES=OFF -DBW64_UNIT_TESTS=OFF -DBW64_PACKAGE_AND_INSTALL=OFF
        - cmake --build . --config Release
      after_success:
        - cd ${TRAVIS_BUILD_DIR}/../m1-transcode
        - chmod +x ./m1-transcode
        - cp -f ./m1-transcode ${TRAVIS_BUILD_DIR}/executables/unix/m1-transcode
        - aws s3 cp m1-transcode s3://${AWS_DEPLOY_BUCKET}/executables/unix/m1-transcode --cache-control no-cache --metadata-directive REPLACE

# ---------------------------------
#
# Deploy 
#
# ---------------------------------

    - stage: deploy
      name: Aggregate & Deploy Libs
      os: linux
      sudo: required
      dist: bionic
      addons:
        apt:
          packages:
            - rsync
            - awscli
          update: true
      install:
        - cd ${TRAVIS_BUILD_DIR}/source && ./scripts/git-prepare-submodules.sh
        - git config user.email "whatsup@mach1.tech"
        - git config user.name "Mach1-Bot"
      script:
        - cd ${TRAVIS_BUILD_DIR}
        - aws s3 cp s3://${AWS_DEPLOY_BUCKET}/mach1spatial-libs mach1spatial-libs_pulldown --recursive
        - rsync -arv mach1spatial-libs_pulldown/ mach1spatial-libs
        - rm -rf mach1spatial-libs_pulldown/
        - aws s3 cp s3://${AWS_DEPLOY_BUCKET}/executables executables_pulldown --recursive
        - rsync -arv executables_pulldown/ executables
        - rm -rf executables_pulldown/
      after_success:
        - cd ${TRAVIS_BUILD_DIR}/source && ./scripts/copy_includes_dev.sh
        - cd ${TRAVIS_BUILD_DIR}/source && ./scripts/copy_to_examples.sh
        - cd ${TRAVIS_BUILD_DIR}/examples/mach1spatial-c/ios/Pod-Mach1SpatialAPI && ${TRAVIS_BUILD_DIR}/source/scripts/git-pod-module.sh
        - cd ${TRAVIS_BUILD_DIR}/examples/mach1spatial-c/android/JitPack-Mach1SpatialAPI && ${TRAVIS_BUILD_DIR}/source/scripts/git-jitpack-module.sh
        - cd ${TRAVIS_BUILD_DIR}/examples/mach1spatial-c/Unity/Unity-Mach1SpatialAPI && ${TRAVIS_BUILD_DIR}/source/scripts/git-unity-module.sh
        - cd ${TRAVIS_BUILD_DIR}/examples/mach1spatial-c/Unreal\ Engine/UE-Mach1SpatialAPI && ${TRAVIS_BUILD_DIR}/source/scripts/git-ue-module.sh
        - cd ${TRAVIS_BUILD_DIR}/examples/mach1spatial-web/m1-web-spatialaudioplayer && ${TRAVIS_BUILD_DIR}/source/scripts/git-webplayer-module.sh
        - cd ${TRAVIS_BUILD_DIR}/examples/mach1spatial-nodejs/mach1spatial-decode && ${TRAVIS_BUILD_DIR}/source/scripts/git-node-decode-module.sh
        # - cd ${TRAVIS_BUILD_DIR}/examples/mach1spatial-nodejs/mach1spatial-encode && ${TRAVIS_BUILD_DIR}/source/scripts/git-node-encode-module.sh
        # - cd ${TRAVIS_BUILD_DIR}/examples/mach1spatial-nodejs/mach1spatial-transcode && ${TRAVIS_BUILD_DIR}/source/scripts/git-node-transcode-module.sh
        - cd ${TRAVIS_BUILD_DIR} && ./source/scripts/deploy.sh

# ---------------------------------
#
# Release 
#
# ---------------------------------

    - stage: release
      name: Aggregate & Release Libs on public repo
      os: linux
      sudo: required
      dist: bionic
      env:
        - M1SDK_RELEASE_PATH=${TRAVIS_BUILD_DIR}/../m1-sdk-release
      addons:
        apt:
          packages:
            - rsync
            - awscli
          update: true
      install:
        - git config user.email "whatsup@mach1.tech"
        - git config user.name "Mach1-Bot"
        - cd ${TRAVIS_BUILD_DIR}/../
        - git clone --recurse-submodules -j8 git@github.com:Mach1Studios/m1-sdk.git m1-sdk-release
        - cd ${M1SDK_RELEASE_PATH}
        # Switch to each submodule and prepare a tmp branch for pushing and merging safely
        - cd ${M1SDK_RELEASE_PATH}/examples/mach1spatial-c/ios/Pod-Mach1SpatialAPI && git fetch && git checkout -b tmp
        - cd ${M1SDK_RELEASE_PATH}/examples/mach1spatial-c/android/JitPack-Mach1SpatialAPI && git fetch && git checkout -b tmp
        - cd ${M1SDK_RELEASE_PATH}/examples/mach1spatial-web/m1-web-spatialaudioplayer && git fetch && git checkout -b tmp
        - cd ${M1SDK_RELEASE_PATH}/examples/mach1spatial-nodejs/mach1spatial-decode && git fetch && git checkout -b tmp
        # - cd ${M1SDK_RELEASE_PATH}/examples/mach1spatial-nodejs/mach1spatial-encode && git fetch && git checkout -b tmp
        # - cd ${M1SDK_RELEASE_PATH}/examples/mach1spatial-nodejs/mach1spatial-transcode && git fetch && git checkout -b tmp
        # Setup tmp branch for root repo
        - cd ${M1SDK_RELEASE_PATH}/ && git fetch && git checkout -b tmp
      script:
        - cd ${M1SDK_RELEASE_PATH}
        - aws s3 cp s3://${AWS_DEPLOY_BUCKET}/mach1spatial-libs ${M1SDK_RELEASE_PATH}/mach1spatial-libs_pulldown --recursive
        - rsync -arv ${M1SDK_RELEASE_PATH}/mach1spatial-libs_pulldown/ ${M1SDK_RELEASE_PATH}/mach1spatial-libs
        - rm -rf ${M1SDK_RELEASE_PATH}/mach1spatial-libs_pulldown/
        - aws s3 cp s3://${AWS_DEPLOY_BUCKET}/executables ${M1SDK_RELEASE_PATH}/executables_pulldown --recursive
        - rsync -arv ${M1SDK_RELEASE_PATH}/executables_pulldown/ executables
        - rm -rf ${M1SDK_RELEASE_PATH}/executables_pulldown/
      after_success:
        - cd ${TRAVIS_BUILD_DIR}/source && ./scripts/copy_includes_release.sh
        - cd ${TRAVIS_BUILD_DIR}/source && ./scripts/copy_to_examples_release.sh
        - cd ${M1SDK_RELEASE_PATH}/examples/mach1spatial-c/ios/Pod-Mach1SpatialAPI && ${TRAVIS_BUILD_DIR}/source/scripts/git-pod-module.sh
        - cd ${M1SDK_RELEASE_PATH}/examples/mach1spatial-c/android/JitPack-Mach1SpatialAPI && ${TRAVIS_BUILD_DIR}/source/scripts/git-jitpack-module.sh
        - cd ${M1SDK_RELEASE_PATH}/examples/mach1spatial-web/m1-web-spatialaudioplayer && ${TRAVIS_BUILD_DIR}/source/scripts/git-webplayer-module.sh
        - cd ${M1SDK_RELEASE_PATH}/examples/mach1spatial-nodejs/mach1spatial-decode && ${TRAVIS_BUILD_DIR}/source/scripts/git-node-decode-module.sh
        # - cd ${M1SDK_RELEASE_PATH}/examples/mach1spatial-nodejs/mach1spatial-encode && ${TRAVIS_BUILD_DIR}/source/scripts/git-node-encode-module.sh
        # - cd ${M1SDK_RELEASE_PATH}/examples/mach1spatial-nodejs/mach1spatial-transcode && ${TRAVIS_BUILD_DIR}/source/scripts/git-node-transcode-module.sh
        - cd ${M1SDK_RELEASE_PATH} && ${TRAVIS_BUILD_DIR}/source/scripts/deploy.sh
        # removing master branch after pushed into release repo is completed for a future deploy without merge conflicts
        - cd ${TRAVIS_BUILD_DIR} && $ git push origin --delete master